{
  "info": {
    "name": "FleteAhora - Modo Tesis (Demo funcional)",
    "_postman_id": "c9a0f6c0-1111-4d10-9a2a-fleteahora-modo-tesis",
    "description": "Colección para probar 5 funcionalidades clave: auth/roles, CRUD de fletes, cotización determinista, asignación, y progreso de estados. Incluye tests para capturar tokens.",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
  },
  "variable": [
    {
      "key": "baseUrl",
      "value": "http://127.0.0.1"
    },
    {
      "key": "appPort",
      "value": "80"
    },
    {
      "key": "adminEmail",
      "value": "admin@demo.cl"
    },
    {
      "key": "adminPass",
      "value": "Demo1234!"
    },
    {
      "key": "transEmail",
      "value": "trans@demo.cl"
    },
    {
      "key": "transPass",
      "value": "Demo1234!"
    },
    {
      "key": "cliEmail",
      "value": "cliente@demo.cl"
    },
    {
      "key": "cliPass",
      "value": "Demo1234!"
    },
    {
      "key": "adminToken",
      "value": ""
    },
    {
      "key": "transToken",
      "value": ""
    },
    {
      "key": "cliToken",
      "value": ""
    },
    {
      "key": "fleteId",
      "value": ""
    }
  ],
  "item": [
    {
      "name": "01 - Autenticación y Roles",
      "item": [
        {
          "name": "Registrar ADMIN",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "url": {
              "raw": "{{baseUrl}}:{{appPort}}/auth/register",
              "host": [
                "{{baseUrl}}"
              ],
              "port": "{{appPort}}",
              "path": [
                "auth",
                "register"
              ]
            },
            "body": {
              "mode": "raw",
              "raw": "{\n  \"name\": \"Admin Demo\",\n  \"email\": \"{{adminEmail}}\",\n  \"password\": \"{{adminPass}}\",\n  \"role\": \"ADMIN\"\n}"
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "",
                  "pm.test(\"201 Created\", function () { pm.response.to.have.status(201); });"
                ]
              }
            }
          ]
        },
        {
          "name": "Login ADMIN",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "url": {
              "raw": "{{baseUrl}}:{{appPort}}/auth/login",
              "host": [
                "{{baseUrl}}"
              ],
              "port": "{{appPort}}",
              "path": [
                "auth",
                "login"
              ]
            },
            "body": {
              "mode": "raw",
              "raw": "{\n  \"email\": \"{{adminEmail}}\",\n  \"password\": \"{{adminPass}}\"\n}"
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "",
                  "pm.test(\"200 OK\", function () { pm.response.to.have.status(200); });",
                  "var data = pm.response.json();",
                  "pm.collectionVariables.set(\"adminToken\", data.token || data.accessToken || \"\");"
                ]
              }
            }
          ]
        },
        {
          "name": "Registrar TRANSPORTISTA",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "url": {
              "raw": "{{baseUrl}}:{{appPort}}/auth/register",
              "host": [
                "{{baseUrl}}"
              ],
              "port": "{{appPort}}",
              "path": [
                "auth",
                "register"
              ]
            },
            "body": {
              "mode": "raw",
              "raw": "{\n  \"name\": \"Trans Demo\",\n  \"email\": \"{{transEmail}}\",\n  \"password\": \"{{transPass}}\",\n  \"role\": \"TRANSPORTISTA\"\n}"
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.response.to.have.status.oneOf([200,201,409]);"
                ]
              }
            }
          ]
        },
        {
          "name": "Login TRANSPORTISTA",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "url": {
              "raw": "{{baseUrl}}:{{appPort}}/auth/login",
              "host": [
                "{{baseUrl}}"
              ],
              "port": "{{appPort}}",
              "path": [
                "auth",
                "login"
              ]
            },
            "body": {
              "mode": "raw",
              "raw": "{\n  \"email\": \"{{transEmail}}\",\n  \"password\": \"{{transPass}}\"\n}"
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "",
                  "pm.response.to.have.status(200);",
                  "var data = pm.response.json();",
                  "pm.collectionVariables.set(\"transToken\", data.token || data.accessToken || \"\");"
                ]
              }
            }
          ]
        },
        {
          "name": "Registrar CLIENTE",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "url": {
              "raw": "{{baseUrl}}:{{appPort}}/auth/register",
              "host": [
                "{{baseUrl}}"
              ],
              "port": "{{appPort}}",
              "path": [
                "auth",
                "register"
              ]
            },
            "body": {
              "mode": "raw",
              "raw": "{\n  \"name\": \"Cliente Demo\",\n  \"email\": \"{{cliEmail}}\",\n  \"password\": \"{{cliPass}}\",\n  \"role\": \"CLIENTE\"\n}"
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.response.to.have.status.oneOf([200,201,409]);"
                ]
              }
            }
          ]
        },
        {
          "name": "Login CLIENTE",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "url": {
              "raw": "{{baseUrl}}:{{appPort}}/auth/login",
              "host": [
                "{{baseUrl}}"
              ],
              "port": "{{appPort}}",
              "path": [
                "auth",
                "login"
              ]
            },
            "body": {
              "mode": "raw",
              "raw": "{\n  \"email\": \"{{cliEmail}}\",\n  \"password\": \"{{cliPass}}\"\n}"
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "",
                  "pm.response.to.have.status(200);",
                  "var data = pm.response.json();",
                  "pm.collectionVariables.set(\"cliToken\", data.token || data.accessToken || \"\");"
                ]
              }
            }
          ]
        },
        {
          "name": "GET /me (CLIENTE)",
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "Authorization",
                "value": "Bearer {{cliToken}}"
              }
            ],
            "url": {
              "raw": "{{baseUrl}}:{{appPort}}/me",
              "host": [
                "{{baseUrl}}"
              ],
              "port": "{{appPort}}",
              "path": [
                "me"
              ]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.response.to.have.status(200);"
                ]
              }
            }
          ]
        }
      ]
    },
    {
      "name": "02 - Fletes",
      "item": [
        {
          "name": "POST /fletes (crear como CLIENTE)",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "Authorization",
                "value": "Bearer {{cliToken}}"
              }
            ],
            "url": {
              "raw": "{{baseUrl}}:{{appPort}}/fletes",
              "host": [
                "{{baseUrl}}"
              ],
              "port": "{{appPort}}",
              "path": [
                "fletes"
              ]
            },
            "body": {
              "mode": "raw",
              "raw": "{\n  \"origenLat\": -33.45694,\n  \"origenLng\": -70.64827,\n  \"destinoLat\": -33.4372,\n  \"destinoLng\": -70.6506,\n  \"pesoKg\": 120.0,\n  \"tipoVehiculo\": \"camioneta\",\n  \"fecha\": \"2025-08-20T09:00:00.000Z\",\n  \"precioEstimado\": \"{{precioCotizado}}\"\n}"
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "",
                  "pm.response.to.have.status.oneOf([200,201]);",
                  "var data = pm.response.json();",
                  "pm.collectionVariables.set(\"fleteId\", data.id || data.flete?.id || \"\");"
                ]
              }
            }
          ]
        },
        {
          "name": "GET /fletes (ADMIN)",
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "Authorization",
                "value": "Bearer {{adminToken}}"
              }
            ],
            "url": {
              "raw": "{{baseUrl}}:{{appPort}}/fletes",
              "host": [
                "{{baseUrl}}"
              ],
              "port": "{{appPort}}",
              "path": [
                "fletes"
              ]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.response.to.have.status(200);"
                ]
              }
            }
          ]
        },
        {
          "name": "GET /fletes/:id (ADMIN)",
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "Authorization",
                "value": "Bearer {{adminToken}}"
              }
            ],
            "url": {
              "raw": "{{baseUrl}}:{{appPort}}/fletes/{{fleteId}}",
              "host": [
                "{{baseUrl}}"
              ],
              "port": "{{appPort}}",
              "path": [
                "fletes",
                "{{fleteId}}"
              ]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.response.to.have.status(200);"
                ]
              }
            }
          ]
        }
      ]
    },
    {
      "name": "03 - Cotización",
      "item": [
        {
          "name": "POST /cotizar (determinístico)",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "Authorization",
                "value": "Bearer {{cliToken}}"
              }
            ],
            "url": {
              "raw": "{{baseUrl}}:{{appPort}}/cotizar",
              "host": [
                "{{baseUrl}}"
              ],
              "port": "{{appPort}}",
              "path": [
                "cotizar"
              ]
            },
            "body": {
              "mode": "raw",
              "raw": "{\n  \"origen\": {\n    \"lat\": -33.45694,\n    \"lng\": -70.64827\n  },\n  \"destino\": {\n    \"lat\": -33.4372,\n    \"lng\": -70.6506\n  },\n  \"pesoKg\": 120.0,\n  \"tipoVehiculo\": \"camioneta\"\n}"
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "",
                  "pm.test(\"200 OK\", function () { pm.response.to.have.status(200); });",
                  "let js = pm.response.json();",
                  "pm.expect(js).to.have.property(\"precioEstimado\");",
                  "pm.collectionVariables.set(\"precioCotizado\", js.precioEstimado);"
                ]
              }
            }
          ]
        }
      ]
    },
    {
      "name": "04 - Asignación y Estados",
      "item": [
        {
          "name": "POST /fletes/:id/asignar (ADMIN)",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "Authorization",
                "value": "Bearer {{adminToken}}"
              }
            ],
            "url": {
              "raw": "{{baseUrl}}:{{appPort}}/fletes/{{fleteId}}/asignar",
              "host": [
                "{{baseUrl}}"
              ],
              "port": "{{appPort}}",
              "path": [
                "fletes",
                "{{fleteId}}",
                "asignar"
              ]
            },
            "body": {
              "mode": "raw",
              "raw": "{}"
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.response.to.have.status.oneOf([200,201]);"
                ]
              }
            }
          ]
        },
        {
          "name": "PATCH estado -> ACEPTADO (TRANS)",
          "request": {
            "method": "PATCH",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "Authorization",
                "value": "Bearer {{transToken}}"
              }
            ],
            "url": {
              "raw": "{{baseUrl}}:{{appPort}}/fletes/{{fleteId}}/estado",
              "host": [
                "{{baseUrl}}"
              ],
              "port": "{{appPort}}",
              "path": [
                "fletes",
                "{{fleteId}}",
                "estado"
              ]
            },
            "body": {
              "mode": "raw",
              "raw": "{\n  \"estado\": \"ACEPTADO\"\n}"
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.response.to.have.status(200);"
                ]
              }
            }
          ]
        },
        {
          "name": "PATCH estado -> EN_RECOGIDA (TRANS)",
          "request": {
            "method": "PATCH",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "Authorization",
                "value": "Bearer {{transToken}}"
              }
            ],
            "url": {
              "raw": "{{baseUrl}}:{{appPort}}/fletes/{{fleteId}}/estado",
              "host": [
                "{{baseUrl}}"
              ],
              "port": "{{appPort}}",
              "path": [
                "fletes",
                "{{fleteId}}",
                "estado"
              ]
            },
            "body": {
              "mode": "raw",
              "raw": "{\n  \"estado\": \"EN_RECOGIDA\"\n}"
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.response.to.have.status(200);"
                ]
              }
            }
          ]
        },
        {
          "name": "PATCH estado -> EN_RUTA (TRANS)",
          "request": {
            "method": "PATCH",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "Authorization",
                "value": "Bearer {{transToken}}"
              }
            ],
            "url": {
              "raw": "{{baseUrl}}:{{appPort}}/fletes/{{fleteId}}/estado",
              "host": [
                "{{baseUrl}}"
              ],
              "port": "{{appPort}}",
              "path": [
                "fletes",
                "{{fleteId}}",
                "estado"
              ]
            },
            "body": {
              "mode": "raw",
              "raw": "{\n  \"estado\": \"EN_RUTA\"\n}"
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.response.to.have.status(200);"
                ]
              }
            }
          ]
        },
        {
          "name": "PATCH estado -> ENTREGADO (TRANS)",
          "request": {
            "method": "PATCH",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "Authorization",
                "value": "Bearer {{transToken}}"
              }
            ],
            "url": {
              "raw": "{{baseUrl}}:{{appPort}}/fletes/{{fleteId}}/estado",
              "host": [
                "{{baseUrl}}"
              ],
              "port": "{{appPort}}",
              "path": [
                "fletes",
                "{{fleteId}}",
                "estado"
              ]
            },
            "body": {
              "mode": "raw",
              "raw": "{\n  \"estado\": \"ENTREGADO\"\n}"
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.response.to.have.status(200);"
                ]
              }
            }
          ]
        }
      ]
    },
    {
      "name": "05 - Mailhog (simulación correo)",
      "item": [
        {
          "name": "GET Mailhog últimos mensajes",
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "url": {
              "raw": "{{baseUrl}}:{{appPort}}/api/v2/messages",
              "host": [
                "{{baseUrl}}"
              ],
              "port": "{{appPort}}",
              "path": [
                "api",
                "v2",
                "messages"
              ]
            }
          },
          "event": [
            {
              "listen": "prerequest",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "",
                  "pm.request.url.host = [pm.collectionVariables.get(\"baseUrl\").replace(\"http://\",\"\").replace(\"https://\",\"\")];",
                  "pm.request.url.port = \"8025\";",
                  "pm.request.url.path = [\"api\",\"v2\",\"messages\"];"
                ]
              }
            },
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "",
                  "pm.test(\"200 OK\", function () { pm.response.to.have.status(200); });",
                  "let js = pm.response.json();",
                  "pm.expect(js).to.have.property(\"total\");"
                ]
              }
            }
          ]
        }
      ]
    }
  ]
}